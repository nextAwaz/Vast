# VolcanoScript — 基础使用文档

版本说明
--------
VolcanoScript（以下简称 VAST）是一个轻量级、可扩展的脚本运行时，使用 Java 实现，提供简单的语法用于快速编写脚本并调用 Java 静态方法与运行时扩展。  
本文件为基础使用手册，面向脚本作者与二次集成开发者，包含安装、运行、语言要点、内置类与扩展接口、常见问题与许可证信息（BSD 3-Clause）。

目录
----
- 概览
- 要求与安装
- 命令行工具（VolcanoCLI）
  - 常用命令
  - 示例
- 嵌入式 / 编程式使用（Java API）
  - Builder 与运行
  - 获取执行结果与调试
- 语言基础
  - 注释与缩进
  - 变量声明与赋值
  - 类型系统与 change 语句
  - 表达式与运算（含字符串重复与数字拼接）
  - 循环（loop）
  - 输入输出（Sys.input / give / do）
  - 导入外部 Java 类
- 内置类与常用函数
- 异常与错误处理
- 扩展与集成
  - 外部扩展（ExternalVolcanoExtension）
  - 注册内建类与全局变量
- 调试与故障排查
- 贡献指南
- 许可证（BSD 3-Clause — 完整文本）

概览
----
VAST 提供：
- 简洁脚本语法用于快速编写脚本并调用 Java 静态方法；
- 基于 Java 的运行时（VolcanoRuntime、VolcanoVM），可嵌入到 Java 应用或作为独立 CLI 使用；
- 严格可选的静态类型声明、字符串重复（`*`）、数字拼接（`++`）、`change` 强制类型转换语句、`give` 与 `do` 用于与外部程序交互。

要求与安装
------------
- Java 21+（或与工程配置相匹配的 JDK）
- 构建工具：Maven/Gradle（视项目仓库提供的构建文件）
- 获取源码：通过 Git 克隆仓库（或下载安装包）

构建（示例，使用 Maven）
```bash
# 假设项目根目录已存在 pom.xml
mvn clean package
# 生成可执行 JAR（如有打包配置）
```

命令行工具（VolcanoCLI）
------------------------
VAST 附带命令行前端 `VolcanoCLI`，用于运行脚本、交互式执行与查看内置帮助。

用法（入口）
```text
Usage: volcano <command> [arguments]

Commands:
  run <script.vast> [--debug]    Execute a script file
  eval "code"                    Execute code directly
  shell                          Start interactive shell
  help [topic]                   Show help information
  version                        Show version info
  list                           List built-in methods
  info <script.vast>             Show script statistics
```

常用命令示例
- 运行脚本文件：
  ```bash
  volcano run examples/hello.vast
  ```
- 以调试模式运行：
  ```bash
  volcano run examples/hello.vast --debug
  ```
- 直接执行一段代码：
  ```bash
  volcano eval "imp Sys; Sys.print(\"Hello Volcano\")"
  ```
- 进入交互式 shell：
  ```bash
  volcano shell
  ```

嵌入式 / 编程式使用（Java API）
------------------------------
VAST 可被嵌入到 Java 程序。主要入口是 `Volcano.Builder` 与 `VolcanoVM` / `VolcanoRuntime`。

示例：以编程方式执行脚本并获取结果
```java
import com.volcano.Volcano;
import com.volcano.vm.VolcanoVM;

public class Example {
    public static void main(String[] args) {
        Volcano.Builder builder = Volcano.builder()
                                         .debug(true); // 可选

        VolcanoVM vm = builder.build();
        String code = "imp Sys\nSys.print(\"Hello from embedded Volcano\")";
        builder.execute(code); // 或者 vm.executeWithResult(...)
    }
}
```

获取脚本执行结果
- 使用 `Volcano.Builder.runWithResult(...)` 或 `VolcanoVM.executeWithResult(...)` 可获取最后一次执行的结果（如果脚本有返回）。

语言基础
--------
以下为 VolcanoScript 的基础语法说明。语言以行/缩进为主要块结构界定（类似 Python 风格的缩进块）。

注释
- 使用 `#` 表示行内注释或整行注释，`#` 后的内容在解析时会被忽略。

缩进
- 块结构使用空格缩进。编译器以缩进层级推断块开始与结束。

变量声明与赋值
- 基本声明：
  - `varName`（仅声明并赋初值请使用 `var name = expr`）
  - `var name`（声明但不赋值 — 在运行时被标记为未初始化）
- 支持显式类型声明：
  - `(int) counter`
  - `(string) name = "Alice"`
  - 在声明处使用 `(type)` 前缀可指定静态类型，类型为 `int`, `double`, `boolean`, `string` 等（规范化支持多种别名）。
- 示例：
  ```vast
  var a = 10
  (int) b = 20
  (string) name = "Volcano"
  ```

未初始化变量
- 声明但未赋值的变量在运行时保存为未初始化哨兵值。使用未初始化变量会抛出 `NullTokenException`。

类型系统与 change 语句
- VAST 支持可选的静态类型约束：若变量声明带类型，后续赋值必须与声明类型严格匹配（无隐式转换）。
- `change` 语句用于在脚本层面进行显式、受控的类型转换与赋值：
  - 语法示例：
    ```vast
    change targetVar::int = sourceVar::string
    ```
  - `change` 会尝试按目标类型将源值转换，若不可转换会抛出 `NotGrammarException`。

表达式与运算
- 支持基本算术与逻辑运算：`+ - * / % > < >= <= == != && ||`
- 字符串拼接使用 `+`（任一操作数为字符串时执行字符串拼接）
- 数字拼接（拼接为整数）使用 `++`：
  - `12 ++ 34` -> 1234（若结果超出 int 会尝试 long）
  - 自增语义：`10 ++` -> 11，`++ 10` -> 11
- 字符串重复：
  - 支持通过 `*` 将字符串（或 StringRepeat）与数字相乘得到重复字符串的 lazy/中间表示（最终调用 toString() 得到结果）。
  - 支持链式重复（如有需要可组合）。
- 表达式求值支持转义字符、字符串字面量以及复杂的运算优先级（乘除优先于加减等）。

循环（loop）
- 语法（示例）：
  ```vast
  loop(5):
      Sys.print("Hello")
  ```
- `loop` 的条件可以为数值（重复次数），或布尔（true 表示无限循环，false 表示不执行）。循环体以缩进块定义。

输入 / 输出
- 输出：`Sys.print(...)` / `Sys.error(...)`
- 输入：`Sys.input(prompt)` 支持多变量输入解析：
  - 脚本可以通过 `var` 声明变量并调用 `Sys.input` 将读取并存储到变量中。
  - `give` 语句用于将当前变量集合以键值对方式传递给外部程序（外部程序可从 VM 获取）。
- `do` 语句用于在脚本中调用外部程序或已注册的对象的方法（支持带行号的表达式求值以便更好的错误定位）。

示例脚本（综合）
```vast
imp Sys
var name = "Alice"
(var) count = 3

loop(count):
    Sys.print("Hello " + name)

# 使用 change 将字符串转换为 int 并赋值
var s = "42"
change num::int = s::string
Sys.print(num)  # 输出 42
```

导入外部 Java 类
- 使用 `imp <FullClassName>` 导入 Java 类或内建类名：
  ```vast
  imp Sys
  imp com.example.MyUtils
  ```
- 在脚本中以 `<Class>.method(args)` 调用静态方法（内部会尝试匹配最优方法签名并处理包装/拆箱、varargs 等）。

内置类与常用函数
----------------
VAST 在运行时提供若干内置类（可通过 `VolcanoVM.BUILTIN_CLASSES` 注册更多）：

- Sys
  - print(Object) / error(Object) / sleep(ms) / time() / exit(code) / input(prompt)
  - multiValueInput(prompt, count)
- Time（TimeUtil）
  - now() / timestamp() / format(long)
- Array（ArrayUtil）
  - create(size) / length(array) / contains(array, value) / get(array, idx) / set(array, idx, val)
- Ops
  - and/or/not / concat / repeat / equals / notEquals
- DataType
  - 字符串、数字、布尔、数组等辅助函数（strLength, numParseInt, toInt, toDouble, toBoolean, typeOf 等）
- DeprecatedMath、EncodingUtil、EnhancedInput、等等（请参阅仓库源码中的类，或通过 CLI `list` 命令查看）

异常与错误处理
----------------
运行时的异常体系以 `VolcanoRuntimeException` 为基础，常见异常包括但不限于：
- NotGrammarException — 语法/语义错误（参数数量不匹配、无效符号使用等）
- NullTokenException — 未初始化变量/空令牌使用
- NonExistentObject / NonExistentExternalLibraryException — 方法或类查找失败
- PassParameterException — 参数传递相关错误
- CannotBeChanged — 不可更改（例如访问受限字段或方法）
- MathError / ExhaustedResourcesException — 计算/资源相关错误
- UnknownVolcanoException — 未知或外部异常包装

对脚本作者的建议：
- 在可能产生异常的表达式处捕获并提供行号（VAST 在若干 API 中支持传递行号以便生成更友好的错误信息）。
- 使用 `--debug` 或通过 Builder 设置 `debug(true)` 开启调试输出，在堆栈与调试信息中可获得更多上下文。

扩展与集成
------------
外部扩展（ExternalVolcanoExtension）
- VAST 支持将一个外部对象注册到 VM 的全局变量 `EXTERNAL_PROGRAM`（通过 `VolcanoVM.setGlobal("EXTERNAL_PROGRAM", obj)`），脚本可通过 `do` 或 `give` 与其交互。
- 若外部对象实现了 `ExternalVolcanoExtension`（项目中定义的接口/约定），运行时会在执行开始时调用 `init()`，执行结束时调用 `cleanup()`。
- `do` 语句会在外部对象上查找并调用匹配的方法（反射），并将脚本参数转换为 Java 对象传入。

注册类与全局变量
- 通过 `VolcanoVM.registerClass(String, Class<?>)` 可将自定义类加入内建类集合，以便脚本使用简短名称引用。
- 通过 `VolcanoVM.setGlobal(String, Object)` / `getGlobal` 可设置或获取运行时全局对象（例如外部扩展、共享配置等）。

调试与故障排查
----------------
开启调试：
- CLI：传入 `--debug` 参数（或 `Volcano.run(script, true)`）
- API：在 Builder 或 VolcanoVM 上调用 `setDebugMode(true)` / `builder().debug(true)`

常见问题与解决方法
- 未找到类或方法：请确认 `imp` 所导入的类全限定名正确，并且类在 classpath 中可用；也可通过 `VolcanoVM.registerClass` 注册简名。
- 未初始化变量错误：在访问变量之前请确保已对其赋值或在声明处给出默认值。
- 类型不匹配：当使用静态类型声明（如 `(int) x`）时，赋值必须严格匹配；使用 `change` 进行可控转换。
- 字符串与转义：字符串字面量支持常见转义字符（\n, \t, \" 等），多段字符串拼接请使用 `+`。

贡献指南
--------
欢迎贡献代码、文档与 issue。建议：
- 提交前运行并确保现有样例/测试通过（若仓库包含 CI 或测试用例，请遵循项目提供的运行方式）。
- 新增功能或修复应附带对应示例或单元测试（若适用）。
- 遵循项目代码风格与提交信息规范（简洁、明确地描述变更目的）。

许可证
------
本项目采用 BSD 3-Clause “New” / “Revised” License 许可。完整许可文本见下方或仓库根目录的 `LICENSE` 文件。

（以下为 BSD 3-Clause 许可全文）
Copyright (c) <year>, <copyright holder>
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
   contributors may be used to endorse or promote products derived from
   this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

例外情况
----
如需更详细的 API 参考或示例代码，请参阅源码目录下的类注释或在仓库中搜索具体类（例如 `VolcanoRuntime`, `VolcanoVM`, `MethodInvocationHandler`, `DoStatementHandler`）。

联系方式
--------
若希望快速交流问题或提交补丁，请在项目仓库中打开 Issue 或 Pull Request。
